<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#0E9F6E">
    <title>智核 AI - 智能对话助手</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <link rel="apple-touch-icon" href="/favicon.ico">
    <link rel="manifest" href="/manifest.json">
</head>
<body>
    <!-- 历史记录抽屉容器 -->
    <div id="history-drawer" class="sidebar-drawer">
        <div class="sidebar">
            <button id="new-chat-btn">+ 新建对话</button>
            <ul id="session-list"></ul>
            <div id="user-info">
                <span id="username-display"></span>
                <button id="logout-btn">退出登录</button>
            </div>
        </div>
    </div>
    <div id="drawer-overlay" class="drawer-overlay"></div>
    
    <!-- 主应用容器，默认隐藏 -->
    <div id="app-container" class="main-container hidden">
        <div class="chat-container">
            <div class="header">
                <button id="history-toggle-btn" title="历史记录" aria-label="打开历史记录">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                        <path d="M12 8v4l2 2"></path>
                    </svg>
                </button>
                <select id="model-select" aria-label="选择AI模型">
                    <option value="">加载中...</option>
                </select>
            </div>
            <div id="chat-box" class="chat-box" role="log" aria-live="polite" aria-label="对话记录"></div>
            <form id="chat-form" class="chat-form">
                <input 
                    type="text" 
                    id="user-input" 
                    placeholder="在这里输入你的问题..." 
                    autocomplete="off"
                    autocapitalize="sentences"
                    autocorrect="on"
                    spellcheck="true"
                    aria-label="输入消息"
                    maxlength="4000"
                >
                <button type="submit" disabled aria-label="发送消息">发送</button>
            </form>
        </div>
    </div>

    <!-- 登录/注册模态框 -->
    <div id="auth-container" class="auth-overlay">
        <div class="auth-box">
            <h2 id="auth-title">登录</h2>
            <form id="auth-form" novalidate>
                <input 
                    type="text" 
                    id="auth-username" 
                    placeholder="用户名" 
                    required 
                    autocomplete="username"
                    aria-label="用户名"
                    maxlength="50"
                >
                <input 
                    type="password" 
                    id="auth-password" 
                    placeholder="密码 (至少6位)" 
                    required 
                    autocomplete="current-password"
                    aria-label="密码"
                    minlength="6"
                    maxlength="128"
                >
                <button type="submit" id="auth-submit-btn">登录</button>
            </form>
            <p id="auth-message" role="alert" aria-live="polite"></p>
            <a href="#" id="switch-auth-mode" role="button" aria-label="切换登录注册模式">没有账号？点击注册</a>
        </div>
    </div>

    <!-- iOS 14.4 兼容的 Polyfills -->
    <script>
        // iOS 14.4 Promise.allSettled polyfill
        if (!Promise.allSettled) {
            Promise.allSettled = function(promises) {
                return Promise.all(promises.map(p => Promise.resolve(p).then(
                    value => ({ status: 'fulfilled', value }),
                    reason => ({ status: 'rejected', reason })
                )));
            };
        }

        // iOS 14.4 fetch timeout polyfill
        if (typeof AbortController === 'undefined') {
            window.AbortController = class AbortController {
                constructor() {
                    this.signal = { aborted: false };
                }
                abort() {
                    this.signal.aborted = true;
                }
            };
        }

        // iOS 14.4 优化：防止页面缩放
        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });
        
        document.addEventListener('gesturechange', function (e) {
            e.preventDefault();
        });
        
        document.addEventListener('gestureend', function (e) {
            e.preventDefault();
        });

        // 防止双击缩放
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // iOS Safari 视口高度修复
        function setViewportHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', vh + 'px');
        }
        
        setViewportHeight();
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', function() {
            setTimeout(setViewportHeight, 100);
        });
    </script>

    <!-- 依赖库加载 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js" 
            integrity="sha512-p2nQoKTdTVpQ9aApDKfHyYczMrjs9yb14vJU4p6zDLKjyfN4pNM2P8H1KxqUEE5XcH78GQ89C8CQMw4/YKzYkw==" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" 
            integrity="sha512-D9gUyxqja7hBtkWpPWGt9wfbfaMGVt9gnyCvYa+jojwwPHLCzUm5i8rpk7vD7wNee9bA35eYIjobYPaQuKS1MQ==" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"
            crossorigin="anonymous" 
            referrerpolicy="no-referrer">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"
            crossorigin="anonymous" 
            referrerpolicy="no-referrer">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/java.min.js"
            crossorigin="anonymous" 
            referrerpolicy="no-referrer">
    </script>
    
    <!-- 主要应用脚本 -->
    <script src="script.js"></script>

    <!-- 服务工作者注册 (PWA支持) -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('SW registered with scope: ', registration.scope);
                }, function(err) {
                    console.log('SW registration failed: ', err);
                });
            });
        }
    </script>

    <!-- 错误监控 -->
    <script>
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            // 在生产环境中，可以发送错误报告到服务器
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            e.preventDefault(); // 防止错误显示在控制台
        });
    </script>

    <!-- 性能监控 -->
    <script>
        if ('performance' in window) {
            window.addEventListener('load', function() {
                setTimeout(function() {
                    const perfData = window.performance.timing;
                    const loadTime = perfData.loadEventEnd - perfData.navigationStart;
                    console.log('页面加载时间:', loadTime + 'ms');
                }, 0);
            });
        }
    </script>
</body>
</html>